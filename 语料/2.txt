 阶段感知推理系统实现计划

 目标

 让智能体能够根据 C 端/B 端用户在全流程中所处的不同阶段，采用不同的思考方式，真正帮助用户。

 核心设计理念

 不同阶段的用户有不同的心理状态和需求：

 C端用户（业主）

 - 准备阶段：迷茫需要引导 → 采用循序渐进的引导式思考
 - 设计阶段：决策焦虑 → 采用多方案对比的树形思考
 - 施工阶段：担心质量 → 采用快速响应的问题解决思考
 - 软装阶段：选择困难 → 采用搭配探索的创意思考
 - 入住阶段：期待谨慎 → 采用简洁直接的回答

 B端用户（商家）

 - 入驻阶段：谨慎观望 → 采用成本收益分析的流程化思考
 - 获客阶段：急于见效 → 采用策略执行的快速响应思考
 - 经营分析阶段：数据驱动 → 采用多维度分析的深度思考
 - 核销结算阶段：关注资金 → 采用准确清晰的直接回答

 实现方案

 1. 新建核心文件

 文件: backend/core/stage_reasoning.py

 包含以下组件：
 - CEndStage / BEndStage 枚举：定义用户阶段
 - StagePsychology 数据类：阶段心理特征配置
 - StageReasoningConfig 数据类：阶段推理配置
 - StagePromptTemplate 数据类：阶段提示词模板
 - StageAwareReasoningEngine 类：阶段感知推理引擎

 2. 阶段推理配置

 C端阶段配置
 ┌──────┬──────────────────┬──────────┬──────────┬────────────────┐
 │ 阶段 │     推理模式     │ 思考深度 │ 共情程度 │    回复风格    │
 ├──────┼──────────────────┼──────────┼──────────┼────────────────┤
 │ 准备 │ CoT + MultiStep  │ 中等     │ 高       │ 引导式、分步骤 │
 ├──────┼──────────────────┼──────────┼──────────┼────────────────┤
 │ 设计 │ ToT + Reflection │ 深度     │ 高       │ 对比分析、专业 │
 ├──────┼──────────────────┼──────────┼──────────┼────────────────┤
 │ 施工 │ ReAct + Direct   │ 中等     │ 中       │ 快速、解决问题 │
 ├──────┼──────────────────┼──────────┼──────────┼────────────────┤
 │ 软装 │ ToT + CoT        │ 中等     │ 高       │ 搭配建议、启发 │
 ├──────┼──────────────────┼──────────┼──────────┼────────────────┤
 │ 入住 │ Direct + CoT     │ 浅层     │ 中       │ 简洁、实用     │
 └──────┴──────────────────┴──────────┴──────────┴────────────────┘
 B端阶段配置
 ┌──────────┬──────────────────┬──────────┬──────────┬──────────────────┐
 │   阶段   │     推理模式     │ 思考深度 │ 共情程度 │     回复风格     │
 ├──────────┼──────────────────┼──────────┼──────────┼──────────────────┤
 │ 入驻     │ MultiStep + CoT  │ 深度     │ 中       │ 流程化、成本分析 │
 ├──────────┼──────────────────┼──────────┼──────────┼──────────────────┤
 │ 获客     │ ReAct + Direct   │ 中等     │ 中       │ 策略性、可执行   │
 ├──────────┼──────────────────┼──────────┼──────────┼──────────────────┤
 │ 经营分析 │ ToT + Reflection │ 深度     │ 低       │ 数据驱动、专业   │
 ├──────────┼──────────────────┼──────────┼──────────┼──────────────────┤
 │ 核销结算 │ Direct + CoT     │ 浅层     │ 低       │ 准确、清晰       │
 └──────────┴──────────────────┴──────────┴──────────┴──────────────────┘
 3. 修改现有文件

 3.1 backend/core/reasoning.py

 - 导入 StageAwareReasoningEngine
 - 在 AdaptiveReasoningStrategy.select_strategy() 中集成阶段感知逻辑
 - 添加 get_stage_aware_prompt() 函数

 3.2 backend/core/memory.py

 - 增强 DecorationJourney 类，添加阶段转换检测
 - 添加 detect_stage_from_query() 方法

 3.3 backend/agents/enhanced_agent.py

 - 在 _prepare_context() 中添加阶段推理配置
 - 修改 _select_reasoning_strategy() 使用阶段感知选择

 3.4 backend/agents/c_end_agent.py

 - 集成阶段感知推理
 - 添加阶段特定的回复模板

 3.5 backend/agents/b_end_agent.py

 - 集成阶段感知推理
 - 添加阶段特定的回复模板

 关键代码结构

 # backend/core/stage_reasoning.py

 class StageAwareReasoningEngine:
     """阶段感知推理引擎"""

     def detect_user_stage(self, query: str, user_profile: UserProfile) -> str:
         """检测用户当前阶段"""

     def get_stage_config(self, stage: str, user_type: str) -> StageReasoningConfig:
         """获取阶段推理配置"""

     def select_reasoning_type(self, query: str, stage: str,
                               user_type: str) -> ReasoningType:
         """基于阶段选择推理类型"""

     def get_stage_prompt(self, stage: str, user_type: str) -> StagePromptTemplate:
         """获取阶段提示词模板"""

     def create_stage_aware_chain(self, query: str, stage: str,
                                   user_type: str) -> ReasoningChain:
         """创建阶段感知的推理链"""

 文件修改清单
 ┌──────────────────────────────────┬──────┬──────────────────────┐
 │               文件               │ 操作 │         说明         │
 ├──────────────────────────────────┼──────┼──────────────────────┤
 │ backend/core/stage_reasoning.py  │ 新建 │ 阶段感知推理核心模块 │
 ├──────────────────────────────────┼──────┼──────────────────────┤
 │ backend/core/reasoning.py        │ 修改 │ 集成阶段感知逻辑     │
 ├──────────────────────────────────┼──────┼──────────────────────┤
 │ backend/core/memory.py           │ 修改 │ 增强阶段检测能力     │
 ├──────────────────────────────────┼──────┼──────────────────────┤
 │ backend/agents/enhanced_agent.py │ 修改 │ 使用阶段感知推理     │
 ├──────────────────────────────────┼──────┼──────────────────────┤
 │ backend/agents/c_end_agent.py    │ 修改 │ C端阶段特定逻辑      │
 ├──────────────────────────────────┼──────┼──────────────────────┤
 │ backend/agents/b_end_agent.py    │ 修改 │ B端阶段特定逻辑      │
 └──────────────────────────────────┴──────┴──────────────────────┘
 详细实现

 4. 自动阶段检测（关键词 + 语义）

 # 阶段检测关键词配置
 C_END_STAGE_KEYWORDS = {
     "准备": {
         "keywords": ["想装修", "打算装修", "准备装修", "预算", "风格", "从哪开始", "怎么入手"],
         "weight": 2.0
     },
     "设计": {
         "keywords": ["设计方案", "效果图", "设计师", "报价", "合同", "平面图", "方案对比"],
         "weight": 2.0
     },
     "施工": {
         "keywords": ["施工", "工人", "水电", "瓷砖", "防水", "空鼓", "验收", "进度", "质量"],
         "weight": 2.5
     },
     "软装": {
         "keywords": ["家具", "沙发", "窗帘", "灯具", "软装", "搭配", "尺寸"],
         "weight": 2.0
     },
     "入住": {
         "keywords": ["入住", "甲醛", "通风", "保养", "维护", "售后"],
         "weight": 2.0
     }
 }

 B_END_STAGE_KEYWORDS = {
     "入驻": {
         "keywords": ["入驻", "开店", "资质", "保证金", "入驻条件", "入驻流程"],
         "weight": 2.5
     },
     "获客": {
         "keywords": ["获客", "客户", "转化", "话术", "触达", "线索", "引流"],
         "weight": 2.0
     },
     "经营分析": {
         "keywords": ["ROI", "数据", "分析", "报表", "趋势", "竞品", "优化"],
         "weight": 2.0
     },
     "核销结算": {
         "keywords": ["结算", "核销", "佣金", "提现", "对账", "账单"],
         "weight": 2.5
     }
 }

 5. 心理共情实现

 每个阶段配置共情短语和回复模板：

 C端共情配置

 C_END_STAGE_EMPATHY = {
     "准备": {
         "opening": "装修确实是个大工程，有些迷茫是正常的",
         "validation": "很多业主刚开始都有这样的困惑",
         "encouragement": "别担心，我来帮您一步步理清思路"
     },
     "设计": {
         "opening": "设计阶段确实需要做很多决定，纠结是正常的",
         "validation": "您考虑得很周全",
         "encouragement": "让我帮您从多个角度分析一下"
     },
     "施工": {
         "opening": "施工中遇到问题不要慌，我们来一起解决",
         "validation": "您发现得及时，还好",
         "encouragement": "这个问题处理得当是可以补救的"
     },
     "软装": {
         "opening": "软装是最能体现个人品味的环节",
         "validation": "您的眼光很好",
         "encouragement": "选择困难很正常，毕竟要住很久"
     },
     "入住": {
         "opening": "恭喜您即将入住新家",
         "validation": "您的谨慎是对的",
         "encouragement": "注意这几点就可以放心入住了"
     }
 }

 B端共情配置

 B_END_STAGE_EMPATHY = {
     "入驻": {
         "opening": "选择平台确实需要谨慎考虑",
         "validation": "您关心成本收益是非常理性的",
         "encouragement": "让我帮您算一笔账，看看是否划算"
     },
     "获客": {
         "opening": "获客是经营的核心，您的关注点很对",
         "validation": "想快速见效是每个商家的期望",
         "encouragement": "我给您一些可以立即执行的策略"
     },
     "经营分析": {
         "opening": "数据分析是优化经营的基础",
         "validation": "您用数据驱动决策非常专业",
         "encouragement": "让我帮您深入分析，找到优化空间"
     },
     "核销结算": {
         "opening": "资金安全是经营的底线",
         "validation": "您关心结算细节是应该的",
         "encouragement": "我来帮您理清结算规则，确保准确"
     }
 }

 6. 阶段特定思考框架

 C端思考框架

 C_END_THINKING_FRAMEWORKS = {
     "准备": """
     【引导式思考框架】
     1. 理解用户当前的困惑点是什么
     2. 评估用户的基础认知水平
     3. 提供循序渐进的引导（先整体后细节）
     4. 给出具体可操作的下一步建议
     5. 预防性提醒常见误区
     """,
     "设计": """
     【对比分析思考框架】
     1. 识别用户的决策困境（在哪些选项间纠结）
     2. 列出可选方案及其核心特点
     3. 从多个维度进行对比（价格/效果/实用性/风险）
     4. 结合用户偏好给出推荐
     5. 提供决策依据和理由
     6. 预留调整空间
     """,
     "施工": """
     【问题解决思考框架】
     1. 快速识别问题类型和紧急程度
     2. 判断是否需要立即行动
     3. 提供明确的解决方案（步骤清晰）
     4. 说明验收标准
     5. 给出预防类似问题的建议
     """,
     "软装": """
     【搭配探索思考框架】
     1. 了解用户的整体风格定位
     2. 分析空间特点和搭配需求
     3. 提供多个搭配方案（主推+备选）
     4. 计算性价比和补贴优惠
     5. 给出购买优先级建议
     """,
     "入住": """
     【简洁实用思考框架】
     1. 确认用户的具体问题
     2. 提供准确的答案或建议
     3. 补充相关注意事项
     """
 }

 B端思考框架

 B_END_THINKING_FRAMEWORKS = {
     "入驻": """
     【成本收益分析框架】
     1. 了解商家的品类和规模
     2. 说明入驻条件和完整流程
     3. 计算预期成本（保证金+服务费+推广费）
     4. 预估潜在收益和回本周期
     5. 对比平台优势，给出入驻建议
     """,
     "获客": """
     【策略执行思考框架】
     1. 分析当前获客痛点和瓶颈
     2. 提供可立即执行的获客策略
     3. 生成场景化话术（首次/跟进/促单）
     4. 推荐最佳触达时机
     5. 预估效果和调整方向
     """,
     "经营分析": """
     【多维度分析思考框架】
     1. 收集和整理相关经营数据
     2. 从多个维度进行分析（流量/转化/客单价/复购）
     3. 识别关键问题和增长机会
     4. 对比行业基准和竞品表现
     5. 提出具体优化建议
     6. 预估改进效果和优先级
     """,
     "核销结算": """
     【准确清晰思考框架】
     1. 确认具体的结算问题
     2. 提供准确的计算或规则说明
     3. 列出费用明细和扣款项
     4. 说明结算周期和到账时间
     5. 补充相关规则提醒
     """
 }

 验证方案

 1. 单元测试：测试阶段检测和推理选择逻辑
 2. 集成测试：模拟不同阶段用户的对话场景
 3. 手动测试：
   - C端准备阶段：问"我想装修，不知道从哪开始"
   - C端施工阶段：问"瓷砖有空鼓怎么办"
   - B端获客阶段：问"怎么提高转化率"
   - B端分析阶段：问"我的ROI怎么样"

 实现步骤

 1. Step 1: 创建 backend/core/stage_reasoning.py - 核心模块
 2. Step 2: 修改 backend/core/reasoning.py - 集成阶段感知
 3. Step 3: 修改 backend/core/memory.py - 增强阶段检测
 4. Step 4: 修改 backend/agents/enhanced_agent.py - 使用新推理
 5. Step 5: 修改 backend/agents/c_end_agent.py - C端集成
 6. Step 6: 修改 backend/agents/b_end_agent.py - B端集成
 7. Step 7: 添加测试用例